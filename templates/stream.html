{% extends "base.html" %}

{% block content %}
<h1>Stream Page</h1>

<!-- Stream Selection Buttons -->
<div class="stream-buttons">
    <div class="home-button" style="display: inline;">
        <a href="/" class="home-btn">üè†</a>
    </div>
    <form method="post" style="display: inline;">
        <input type="hidden" name="stream_name" value="1">
        <input type="hidden" name="game_name" value="{{ game_name }}">
        <input type="hidden" name="game_url" value="{{ game_url }}">
        <button type="submit" class="stream-btn">Stream 1</button>
    </form>
    <form method="post" style="display: inline;">
        <input type="hidden" name="stream_name" value="2">
        <input type="hidden" name="game_name" value="{{ game_name }}">
        <input type="hidden" name="game_url" value="{{ game_url }}">
        <button type="submit" class="stream-btn">Stream 2</button>
    </form>
    <form method="post" style="display: inline;">
        <input type="hidden" name="stream_name" value="3">
        <input type="hidden" name="game_name" value="{{ game_name }}">
        <input type="hidden" name="game_url" value="{{ game_url }}">
        <button type="submit" class="stream-btn">Stream 3</button>
    </form>
</div>

<!-- Display Selected Stream -->
<div class="stream-display">
    <h2>Selected Stream:</h2>
    <p>{{ selected_stream }}</p>
    <p>{{ game_name }}</p>
    <p>https://embedsports.me/{{ game_url }}-{{ selected_stream }}</p>

    <div class="iframe-container">
        <iframe src="https://embedsports.me/{{ game_url }}-{{ selected_stream }}" 
                scrolling="no" 
                allowfullscreen 
                allowtransparency 
                referrerpolicy="unsafe-url">
        </iframe>
    </div>
</div>

<!-- Team Boxscore -->
<div class="team-boxscore">
    <h2>Team Boxscore</h2>
    <table id="team-boxscore-table">
        <thead>
            <tr>
                <th>Team</th>
                <th>FGM-FGA</th>
                <th>FG%</th>
                <th>3PTM-3PTA</th>
                <th>3PT%</th>
                <th>FTM-FTA</th>
                <th>FT%</th>
                <th>REB</th>
                <th>OREB</th>
                <th>DREB</th>
                <th>AST</th>
                <th>STL</th>
                <th>BLK</th>
                <th>TO</th>
                <th>TTO</th>
                <th>ToTo</th>
                <th>TECH</th>
                <th>ToTECH</th>
                <th>FLAG</th>
                <th>Points Conceded Off Turnovers</th>
                <th>FBPs</th>
                <th>PIP</th>
                <th>PF</th>
                <th>LL</th>

            </tr>
        </thead>
        <tbody>
            <!-- Rows will be dynamically populated here -->
        </tbody>
    </table>
</div>

<!-- Player Boxscore -->
<div class="player-boxscore">
    <h2>Player Boxscore</h2>
    
    <!-- Tabs for Teams -->
    <div class="team-tabs">
        <!-- Tabs will be dynamically populated here -->
    </div>
    
    <!-- Player Boxscore Table -->
    <table id="player-boxscore-table">
        <thead>
            <tr>
                <!-- <th>Team</th> -->
                <th>Name</th>
                <th>Is Starter</th>
                <th>MIN</th>
                <th>FGM-FGA</th>
                <th>3PTM-3PTA</th>
                <th>FTM-FTA</th>
                <th>OREB</th>
                <th>DREB</th>
                <th>REB</th>
                <th>AST</th>
                <th>STL</th>
                <th>BLK</th>
                <th>TO</th>
                <th>PF</th>
                <th>+/-</th>
                <th>PTS</th>
            </tr>
        </thead>
        <tbody>
            <!-- Rows will be dynamically populated here -->
        </tbody>
    </table>
</div>

<script>
    let allPlayers = []; // Store all players globally for filtering

    // Function to fetch player and team boxscore data
    async function fetchBoxscores() {
        const gameName = "{{ game_name }}";
        const gameUrl = "{{ game_url }}";

        const response = await fetch(`/player_boxscore?game_name=${encodeURIComponent(gameName)}&game_url=${encodeURIComponent(gameUrl)}`);
        if (response.ok) {
            const data = await response.json();
            updateTeamBoxscoreTable(data.teams);
            allPlayers = data.players; // Store all players globally
            createTeamTabs(data.players); // Create tabs based on teams
            updatePlayerBoxscoreTable(allPlayers); // Default to show all players
        }
    }

    // Function to update the team boxscore table
    function updateTeamBoxscoreTable(teams) {
        const tbody = document.querySelector('#team-boxscore-table tbody');
        tbody.innerHTML = ''; // Clear existing rows

        teams.forEach(team => {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${team.Team}</td>
                <td>${team.FG}</td>
                <td>${team.fieldGoalPct}</td>
                <td>${team.threePointers}</td>
                <td>${team.threePointFieldGoalPct}</td>
                <td>${team.FT}</td>
                <td>${team.freeThrowPct}</td>
                <td>${team.Rebounds}</td>
                <td>${team.OffensiveRebounds}</td>
                <td>${team.DefensiveRebounds}</td>
                <td>${team.Assists}</td>
                <td>${team.Steals}</td>
                <td>${team.Blocks}</td>
                <td>${team.Turnover}</td>
                <td>${team.TeamTurnovers}</td>
                <td>${team.TotalTurnovers}</td>
                <td>${team.TechnicalFouls}</td>
                <td>${team.TotalTechnicalFouls}</td>
                <td>${team.FlagrantFouls}</td>
                <td>${team.PointsConcededOffTurnovers}</td>
                <td>${team.FastBreakPoints}</td>
                <td>${team.PointsInPaint}</td>
                <td>${team.Fouls}</td>
                <td>${team.LargestLead}</td>
            `;
            tbody.appendChild(row);
        });
    }

    // Function to create team tabs dynamically
    function createTeamTabs(players) {
        const teamTabs = document.querySelector('.team-tabs');
        teamTabs.innerHTML = ''; // Clear existing tabs

        // Get unique team names
        const teams = [...new Set(players.map(player => player.Team))];

        // Create a tab for each team
        teams.forEach(team => {
            const button = document.createElement('button');
            button.className = 'team-tab';
            button.textContent = team;
            button.onclick = () => filterPlayersByTeam(team); // Filter players by team on click
            teamTabs.appendChild(button);
        });

        // Add an "All" tab
        const allButton = document.createElement('button');
        allButton.className = 'team-tab';
        allButton.textContent = 'All';
        allButton.onclick = () => updatePlayerBoxscoreTable(allPlayers); // Show all players
        teamTabs.appendChild(allButton);
    }

    // Function to filter players by team
    function filterPlayersByTeam(team) {
        const filteredPlayers = allPlayers.filter(player => player.Team === team);
        updatePlayerBoxscoreTable(filteredPlayers);
    }

    // Function to update the player boxscore table
    function updatePlayerBoxscoreTable(players) {
        const tbody = document.querySelector('#player-boxscore-table tbody');
        tbody.innerHTML = ''; // Clear existing rows

        players.forEach(player => {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${player.Name}</td>
                <td>${player.IsStarter}</td>
                <td>${player.MIN}</td>
                <td>${player.FG}</td>
                <td>${player.threePT}</td>
                <td>${player.FT}</td>
                <td>${player.OREB}</td>
                <td>${player.DREB}</td>
                <td>${player.REB}</td>
                <td>${player.AST}</td>
                <td>${player.STL}</td>
                <td>${player.BLK}</td>
                <td>${player.TO}</td>
                <td>${player.PF}</td>
                <td>${player.plusMinus}</td>
                <td>${player.PTS}</td>
            `;
            tbody.appendChild(row);
        });
    }

    // Refresh both boxscores every 10 seconds
    setInterval(fetchBoxscores, 10000);

    // Initial fetch
    fetchBoxscores();
</script>

<style>
    .team-tabs {
        margin-bottom: 20px;
    }

    .team-tab {
        margin-right: 5px;
        padding: 10px 20px;
        font-size: 14px;
        cursor: pointer;
        background-color: #264653;
        color: white;
        border: none;
        border-radius: 5px;
    }

    .team-tab:hover {
        background-color: #2a9d8f;
    }
</style>

{% endblock %}
